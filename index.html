<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ¿æºå…±äº«å¹³å° - å†…éƒ¨ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #e74c3c;
            --light-bg: #ecf0f1;
            --white: #ffffff;
            --text-dark: #2c3e50;
            --text-light: #7f8c8d;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-bg);
            color: var(--text-dark);
            line-height: 1.6;
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        }

        .login-box {
            background: var(--white);
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 400px;
        }

        .login-box h1 {
            text-align: center;
            margin-bottom: 30px;
            color: var(--primary-color);
            font-size: 28px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-dark);
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #bdc3c7;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
            font-family: inherit;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
        }

        .btn {
            padding: 12px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background-color: var(--secondary-color);
            color: var(--white);
            width: 100%;
        }

        .btn-primary:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .btn-secondary {
            background-color: var(--light-bg);
            color: var(--text-dark);
            border: 2px solid var(--secondary-color);
            width: 100%;
        }

        .btn-secondary:hover {
            background-color: var(--secondary-color);
            color: var(--white);
        }

        .btn-small {
            padding: 8px 12px;
            font-size: 12px;
            display: inline-block;
            width: auto;
        }

        .btn-danger {
            background-color: var(--warning-color);
            color: var(--white);
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .main-container {
            display: none;
            flex-direction: row;
        }

        .main-container.active {
            display: flex;
        }

        .sidebar {
            width: 250px;
            background-color: var(--primary-color);
            color: var(--white);
            min-height: 100vh;
            padding: 20px;
            position: fixed;
            left: 0;
            top: 0;
            overflow-y: auto;
        }

        .sidebar h2 {
            margin-bottom: 30px;
            font-size: 20px;
            border-bottom: 2px solid rgba(255,255,255,0.2);
            padding-bottom: 10px;
        }

        .sidebar ul {
            list-style: none;
        }

        .sidebar li {
            margin-bottom: 15px;
        }

        .sidebar a {
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            padding: 10px 15px;
            display: block;
            border-radius: 5px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .sidebar a:hover, .sidebar a.active {
            background-color: var(--secondary-color);
            color: var(--white);
        }

        .content {
            margin-left: 250px;
            padding: 30px;
            flex: 1;
            min-height: 100vh;
        }

        .header {
            background-color: var(--white);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 28px;
            color: var(--primary-color);
        }

        .user-info {
            text-align: right;
            font-size: 14px;
        }

        .user-info p {
            margin: 5px 0;
            color: var(--text-light);
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .card {
            background-color: var(--white);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .card h2 {
            margin-bottom: 20px;
            color: var(--primary-color);
            font-size: 22px;
            border-bottom: 2px solid var(--light-bg);
            padding-bottom: 10px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-row.full {
            grid-template-columns: 1fr;
        }

        .image-upload {
            border: 2px dashed var(--secondary-color);
            border-radius: 5px;
            padding: 20px;
            text-align: center;
            background-color: var(--light-bg);
            cursor: pointer;
            transition: all 0.3s;
        }

        .image-upload:hover {
            background-color: rgba(52, 152, 219, 0.1);
        }

        .image-upload input {
            display: none;
        }

        .image-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .image-item {
            position: relative;
            border-radius: 5px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .image-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            display: block;
        }

        .image-item .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: var(--warning-color);
            color: var(--white);
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .image-item:hover .remove-btn {
            opacity: 1;
        }

        .listing-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .listing-card {
            background-color: var(--white);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }

        .listing-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        .listing-card-image {
            width: 100%;
            height: 200px;
            background-color: var(--light-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
            font-size: 12px;
            overflow: hidden;
        }

        .listing-card-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .listing-card-content {
            padding: 15px;
        }

        .listing-card-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .listing-card-price {
            font-size: 18px;
            color: var(--success-color);
            font-weight: 700;
            margin-bottom: 10px;
        }

        .listing-card-info {
            font-size: 12px;
            color: var(--text-light);
            margin-bottom: 10px;
        }

        .listing-card-actions {
            display: flex;
            gap: 8px;
            justify-content: space-between;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: var(--white);
            border-radius: 10px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--text-light);
        }

        .modal-close:hover {
            color: var(--text-dark);
        }

        .listing-detail-image {
            width: 100%;
            max-height: 400px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .generated-caption {
            background-color: var(--light-bg);
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid var(--secondary-color);
            margin-top: 15px;
            font-size: 14px;
            line-height: 1.8;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--secondary-color) 0%, #2980b9 100%);
            color: var(--white);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 32px;
            margin: 0;
        }

        .stat-card p {
            font-size: 12px;
            margin: 5px 0 0 0;
            opacity: 0.9;
        }

        .demo-credentials {
            background-color: var(--light-bg);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 12px;
            border-left: 4px solid var(--secondary-color);
        }

        .demo-credentials p {
            margin: 5px 0;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: static;
                min-height: auto;
            }
            .content {
                margin-left: 0;
            }
            .form-row {
                grid-template-columns: 1fr;
            }
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .listing-grid {
                grid-template-columns: 1fr;
            }
        }
        @media (max-width: 768px) {
    .main-container {
        flex-direction: column;   /* ä¾§è¾¹æ åœ¨ä¸Šï¼Œå†…å®¹åœ¨ä¸‹ */
    }

    .sidebar {
        width: 100%;
        position: static;
        min-height: auto;
    }

    .content {
        margin-left: 0;
        padding: 15px;           /* æ‰‹æœºè¾¹è·å°ä¸€ç‚¹ */
    }

    .header {
        flex-direction: column;  /* æ ‡é¢˜å’Œç”¨æˆ·ä¿¡æ¯ä¸Šä¸‹æ’ */
        align-items: flex-start;
        gap: 10px;
    }

    .stats-grid {
        grid-template-columns: repeat(2, 1fr); /* ä»ªè¡¨æ¿ 2 åˆ— */
    }

    .form-row {
        grid-template-columns: 1fr;           /* è¡¨å•ä¸€åˆ— */
    }

    .listing-grid {
        grid-template-columns: 1fr;           /* æˆ¿æºå¡ç‰‡ä¸€åˆ— */
    }

    .search-box {
        flex-direction: column;               /* æœç´¢æ¡ä»¶ä¸Šä¸‹æ’ï¼Œé¿å…å¤ªæŒ¤ */
        align-items: stretch;
    }

    .search-box > * {
        width: 100%;                          /* æ¯ä¸ªè¾“å…¥æ¡†ä¸‹å æ»¡ä¸€è¡Œ */
    }
}

    </style>

    <script type="text/javascript" nonce="995bc22bf98145a8837d2776e01" src="//local.adguard.org?ts=1764346975285&amp;type=content-script&amp;dmn=ppl-ai-code-interpreter-files.s3.amazonaws.com&amp;url=https%3A%2F%2Fppl-ai-code-interpreter-files.s3.amazonaws.com%2Fweb%2Fdirect-files%2F570057e7b393865b2e4de6d99b8b20c9%2F5f0d8a6d-54ce-4661-b2ef-61877941f1e6%2F94012b36.html%3Fresponse-content-disposition%3Dattachment%253B%2520filename%253Dindex_fixed.html%253B%2520filename%252A%253DUTF-8%2527%2527index_fixed.html%26AWSAccessKeyId%3DASIA2F3EMEYEQES7ENEB%26Signature%3DBwVd0sPwY5wL16F68jjgUnaWvL0%253D%26x-amz-security-token%3DIQoJb3JpZ2luX2VjEPH%252F%252F%252F%252F%252F%252F%252F%252F%252F%252FwEaCXVzLWVhc3QtMSJHMEUCIQDC7k420b9uOyglbBjDcjwfjYmwpRQFgiZBMkMdAPif8gIgJ6DhdHBpAlt3k3p6Fk2anQ4hOx%252Fj3E5bmIzTtwVXJrkq%252FAQIuv%252F%252F%252F%252F%252F%252F%252F%252F%252F%252FARABGgw2OTk3NTMzMDk3MDUiDBgg2UtXc3B0AajwGSrQBJ1P9s0XPswFUyg8FfkACyvcaVoIan09OmwpSr2MBtbjcVBeIyCFCklA0tI4AqP92HnQCM7WtlP0nbo22tjgSX1jXAXrRdQjdZMJ5qZ7I%252FN0q4CKnf5iLFrX%252FgmLVBP%252Bta%252BlcABiYh%252FGDoahw2Yqay6JFo7ymCKSX4vO9R99WIgkdqd2u%252By9QmeRzwSj1HdpwIurei%252BwCw7k9uBnytwHKYobSjkwuX9oO%252F93WivR%252BvCBF9HhXCdXEHbGvKuq61y7npa8HBa1XAGyKpMymEBo88IurwEJTd0o8Oomn4Q730PrmeW7JeP8MH38pbZzvDVYsWkdnt7e84SfDV6oIDhSdanlkMiAkhhRfDDen3sRT5OEaM2eRATyuc18HpWyJhlpS3777v%252BHNiERmmWgYlkXrVbr3SFKKqjJ8Pm339RbqMAtIjNc40yhuIbe%252B9zX7B%252FksqWX%252FP5MQejxZF4%252B9R0A8DlSIxV8%252FnLahMddHyZ5ZedT%252F8SRG2qluIFQGrB5ztooyntqKEDhbZ7C1vcaGoWMY8vHCaYBCi%252BnRcS1vxgBo4l4GJBAvj7gaeGlqOm4LNri%252FdWOHj3mmJS55PmZseOYCU38i9Rl8Nv5BUhmC7LvquAXJckRuRi77JLyxiIWRFYFM%252FkQmfgXnb9KQ5iWtUswgkF2W7DXhK%252B%252BQpCAkQRQ97OKbHF4TvfmftLaLzmFGwSwku8sibCQkSHnAXwa51K9pV9O8qgqMFCxrT8C3B4q%252BszXw%252F90Hr2wSuBRY%252BXEZ2cjjZ2xBIuDqwcAvS2ZZc7epG4w%252F5mnyQY6mAErBzbMFe6Rso%252FaVDF1dDuEX6QHnqpZ%252BL2V8RBMDmveXlsjIsgsfwvbKjywqPMF70N1%252BdzJ7OlPV%252FXTYEs6LW%252FLVTKnOjlilT1aMNYb6xxwtMhlClfk0%252BFCrrPMVcq92BuoQSaImyja0ykVhEuem7f2WXcYW7RoAvSmOQZNgH1eOEydfYZAFyN3nR05PDUq80ykKbaxneQKkg%253D%253D%26Expires%3D1764349700&amp;app=comet.exe&amp;css=3&amp;js=1&amp;rel=1&amp;rji=1&amp;sbe=1&amp;stealth=1&amp;st-dnt"></script><script type="text/javascript" nonce="995bc22bf98145a8837d2776e01" src="//local.adguard.org?ts=1764346975285&amp;name=AdGuard%20Extra&amp;name=AdGuard%20Popup%20Blocker&amp;type=user-script"></script><script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
        import { 
            getFirestore, collection, addDoc, getDocs, query, orderBy, deleteDoc, doc, setDoc, runTransaction 
        } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";
        import { 
            getStorage, ref, uploadBytes, getDownloadURL 
        } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCeVd0dSa1c7Pe7GrkbLQhv_t1SiY7msyU",
            authDomain: "wehome-listings.firebaseapp.com",
            projectId: "wehome-listings",
            storageBucket: "wehome-listings.firebasestorage.app",
            messagingSenderId: "803741960436",
            appId: "1:803741960436:web:c4bf134af50d59c80676a1",
            measurementId: "G-TL44X75XBG"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

       window._firestore = { db, collection, addDoc, getDocs, query, orderBy, deleteDoc, doc, setDoc, runTransaction };
        window._storage = { storage, ref, uploadBytes, getDownloadURL };
    </script>
</head>

<body>
    <div id="loginPage" class="login-container">
        <div class="login-box">
            <h1>ğŸ  æˆ¿æºå…±äº«å¹³å°</h1>
            <div class="demo-credentials">
                <p><strong>æ¼”ç¤ºè´¦å·ï¼š</strong></p>
                <p>ç”¨æˆ·åï¼šgohjunkhai</p>
                <p>å¯†ç ï¼š123456</p>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label>ç”¨æˆ·å</label>
                    <input type="text" id="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" required>
                </div>
                <div class="form-group">
                    <label>å¯†ç </label>
                    <input type="password" id="password" placeholder="è¯·è¾“å…¥å¯†ç " required>
                </div>
                <button type="submit" class="btn btn-primary">ç™»å½•</button>
            </form>
            <hr style="margin: 20px 0;">

<h3 style="text-align:center; margin-bottom:10px; font-size:16px;">æˆ–ä½¿ç”¨æ‰‹æœºå·ç ç™»å½•</h3>

<form id="phoneLoginForm">
    <div class="form-group">
        <label>æ‰‹æœºå·ç ï¼ˆå«åŒºå·ï¼‰</label>
        <!-- ä¾‹ï¼š+60xxx -->
        <input type="tel" id="phoneNumber" placeholder="+60..." required>
    </div>

    <div id="recaptcha-container" style="margin-bottom: 10px;"></div>

    <button type="button" id="sendCodeBtn" class="btn btn-secondary" style="margin-bottom:10px;">
        å‘é€éªŒè¯ç 
    </button>

    <div class="form-group">
        <label>çŸ­ä¿¡éªŒè¯ç </label>
        <input type="text" id="smsCode" placeholder="è¾“å…¥æ”¶åˆ°çš„6ä½éªŒè¯ç ">
    </div>

    <button type="button" id="confirmCodeBtn" class="btn btn-primary">
        ä½¿ç”¨æ‰‹æœºç™»å½•
    </button>
</form>

        </div>
    </div>

    <div id="mainApp" class="main-container">
        <div class="sidebar">
            <h2>èœå•</h2>
            <ul>
                <li><a class="menu-link active" data-section="dashboard">ğŸ“Š ä»ªè¡¨æ¿</a></li>
                <li><a class="menu-link" data-section="upload">ğŸ“¤ ä¸Šä¼ æˆ¿æº</a></li>
                <li><a class="menu-link" data-section="listings">ğŸ“‹ æˆ¿æºåº“</a></li>
                <li><a class="menu-link" data-section="my-listings">âœ¨ æˆ‘çš„æˆ¿æº</a></li>
                <li><a class="menu-link" data-section="export">ğŸ’¾ å¯¼å‡ºæ•°æ®</a></li>
                <li><a class="menu-link" data-section="settings">âš™ï¸ è®¾ç½®</a></li>
                <li><a id="logoutBtn">ğŸšª ç™»å‡º</a></li>
            </ul>
        </div>

        <div class="content">
            <div class="header">
                <h1>æˆ¿æºå…±äº«å¹³å°</h1>
                <div class="user-info">
                    <p>æ¬¢è¿ï¼Œ<strong id="currentUser"></strong></p>
                    <p id="currentTime"></p>
                </div>
            </div>

            <div id="dashboard" class="section active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3 id="totalListings">0</h3>
                        <p>æ€»æˆ¿æºæ•°</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="myListings">0</h3>
                        <p>æˆ‘çš„æˆ¿æº</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="teamMembers">0</h3>
                        <p>å›¢é˜Ÿæˆå‘˜</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="thisMonth">0</h3>
                        <p>æœ¬æœˆæ–°å¢</p>
                    </div>
                </div>
                <div class="card">
                    <h2>æœ€è¿‘ä¸Šä¼ çš„æˆ¿æº</h2>
                    <div id="recentListings" class="listing-grid"></div>
                </div>
<div class="card">
    <h2>æœ€è¿‘ 7 å¤©åˆ é™¤çš„æˆ¿æº</h2>
    <div id="recentDeleted" style="font-size: 14px; line-height: 1.6;">
        <!-- åŠ¨æ€ç”Ÿæˆ -->
    </div>
</div>


            </div>

            <div id="upload" class="section">
                <div class="card">
                    <h2>ä¸Šä¼ æ–°æˆ¿æº</h2>
                    <form id="uploadForm">
<div class="form-group">
    <label>æˆ¿äº§ç±»å‹ *</label>
    <input
        type="text"
        id="propertyType"
        placeholder="ä¾‹ï¼šApartment / 2 Storey Terrace / Shoplot"
        required
    >
</div>

<div class="form-group">
    <label>ä½ç½® @ åŒºåŸŸ *</label>
    <input type="text" id="location" placeholder="ä¾‹ï¼šThe Wave Residence @ Kota Laksamana" required>
</div>
 
                <!-- â¬‡ï¸ åœ¨è¿™é‡Œæ–°å¢è¿™ä¸€æ®µå·å±é€‰æ‹© â¬‡ï¸ -->
<div class="form-row full">
    <div class="form-group">
        <label>æ‰€åœ¨å·å± *</label>
        <select id="state" required>
            <option value="">-- é€‰æ‹©å·å± --</option>
            <option value="Melaka">Melaka</option>
            <option value="Negeri Sembilan">Negeri Sembilan</option>
            <option value="Others">Others State</option>
        </select>
    </div>
</div>
                        
</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>ä»·æ ¼ (RM) *</label>
                                <input type="text" id="price" placeholder="ä¾‹ï¼š1000" required>
                            </div>
                            <div class="form-group">
                                <label>é¢ç§¯ (sq.ft) *</label>
                                <input type="text" id="area" placeholder="ä¾‹ï¼š22x70 or 1540" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>æˆ¿é—´</label>
                                <input type="number" id="bedrooms" value="0">
                            </div>
                            <div class="form-group">
                                <label>æµ´å®¤</label>
                                <input type="number" id="bathrooms" value="0">
                            </div>
                        </div>

                        <div class="form-row full">
                            <div class="form-group">
                                <label>æ¥¼å±‚</label>
                                <input type="text" id="floor" placeholder="Floor, Example GF 1F 2F">
                            </div>
                        </div>

                        <div class="form-row full">
                            <div class="form-group">
                                <label>åœè½¦ä½</label>
                                <input type="text" id="carpark" placeholder="0, 1, 2 or Open">
                            </div>
                        </div>

                        <div class="form-row full">
                            <div class="form-group">
                                <label>æœå‘</label>
                                <input type="text" id="direction" placeholder="North, West, Southeast">
                            </div>
                        </div>

                        <div class="form-row full">
                            <div class="form-group">
                                <label>å®¶ç§ Furnished</label>
                                <input type="text" id="furnished" placeholder="Fully or Partially, leave BLANK if Unfurnished">
                            </div>
                        </div>

                        <div class="form-row full">
                            <div class="form-group">
                                <label>Security Deposit</label>
                                <input type="text" id="securityDeposit" placeholder="1 or 2">
                            </div>
                        </div>

                        <div class="form-row full">
                            <div class="form-group">
                                <label>Utilities Deposit</label>
                                <input type="text" id="utilitiesDeposit" placeholder="0.5, 1 or Own Apply">
                            </div>
                        </div>

                        <div class="form-row full">
                            <div class="form-group">
                                <label>Other Deposit</label>
                                <input type="text" id="otherDeposit" placeholder="Renovation Deposit">
                            </div>
                        </div>

                        <div class="form-row full">
                            <div class="form-group">
                                <label>Nearby 1</label>
                                <input type="text" id="nearby1" placeholder="500m to 99 Speed Mart">
                            </div>
                        </div>
<div class="form-row full">
    <div class="form-group">
        <label>ç§æ—é™åˆ¶ Race</label>
        <div id="raceOptions" style="display:flex; flex-wrap:wrap; gap:10px; font-size:14px;">
            <label><input type="checkbox" name="race" value="All Race"> All Race</label>
            <label><input type="checkbox" name="race" value="Malay"> Malay</label>
            <label><input type="checkbox" name="race" value="Indian"> Indian</label>
            <label><input type="checkbox" name="race" value="Chinese"> Chinese</label>
        </div>
    </div>
</div>

                        <div class="form-row full">
                            <div class="form-group">
                                <label>Nearby 2</label>
                                <input type="text" id="nearby2" placeholder="1.0km to Dataran">
                            </div>
                        </div>

                        <div class="form-row full">
                            <div class="form-group">
                                <label>Nearby 3</label>
                                <input type="text" id="nearby3" placeholder="15min to Jonker">
                            </div>
                        </div>

                        <div class="form-row full">
                            <div class="form-group">
                                <label>Nearby 4</label>
                                <input type="text" id="nearby4" placeholder="20min to Taman">
                            </div>
                        </div>

                        <div class="form-row full">
                            <div class="form-group">
                                <label>å¤‡æ³¨</label>
                                <textarea id="remarks" placeholder="Race, No Indian..."></textarea>
                            </div>
                        </div>

                        <div class="form-row full">
                            <div class="form-group">
                                <label>Agent Name</label>
                                <textarea id="agentName" placeholder="Jun Khai"></textarea>
                            </div>
                        </div>

                        <div class="form-row full">
                            <div class="form-group">
                                <label>åœ°å€</label>
                                <textarea id="address" placeholder="No 6-1, Jalan Rahmat"></textarea>
                            </div>
                        </div>

                        <div class="form-row full">
                            <div class="form-group">
                                <label>ä¸Šä¼ ç…§ç‰‡ï¼Œè¯·ä¾æ®æ’ç‰ˆé¡ºåºä¸Šä¼ ï¼Œä¾‹ï¼šå¤–è§‚-å®¢å…-å¨æˆ¿-æˆ¿é—´-å•æ‰€-Facilities (æœ€å¤š20å¼ ) *</label>
                                <div class="image-upload" id="imageUpload">
                                    <p>ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°è¿™é‡Œä¸Šä¼ </p>
                                    <input type="file" id="imageInput" multiple accept="image/*">
                                </div>
                                <div class="image-preview" id="imagePreview"></div>
                            </div>
                        </div>

                        <div class="form-row full">
                            <div class="form-group">
                                <label>è‡ªåŠ¨ç”Ÿæˆçš„æˆ¿æºæ–‡æ¡ˆ</label>
                                <button type="button" class="btn btn-secondary btn-small" id="generateCaption">ç”Ÿæˆæ–‡æ¡ˆ</button>
                                <button type="button" class="btn btn-secondary btn-small" id="copyCaption">å¤åˆ¶æ–‡æ¡ˆ</button>
                                <div id="generatedCaption"></div>
                            </div>
                        </div>

                        <div class="action-buttons">
                            <button type="submit" class="btn btn-primary">âœ… å‘å¸ƒæˆ¿æº</button>
                            <button type="reset" class="btn btn-secondary">ğŸ”„ æ¸…ç©ºè¡¨å•</button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="listings" class="section">
                <div class="card">
                    <h2>æ‰€æœ‰æˆ¿æºåº“</h2>
<div class="search-box" style="display:flex; flex-wrap:wrap; gap:8px; align-items:center;">
    <input type="text" id="searchListings" placeholder="å…³é”®å­—ï¼šä½ç½® / ç±»å‹ / Code" style="min-width:200px;">

    <select id="filterState">
        <option value="">å…¨éƒ¨å·å±</option>
        <option value="Melaka">Melaka</option>
        <option value="Negeri Sembilan">Negeri Sembilan</option>
        <option value="Others">Others State</option>
    </select>

    <input type="number" id="priceMin" placeholder="æœ€ä½ä»·" style="width:90px;">
    <input type="number" id="priceMax" placeholder="æœ€é«˜ä»·" style="width:90px;">

    <select id="filterFurnished">
        <option value="">å®¶ç§ä¸é™</option>
        <option value="Fully">Fully Furnished</option>
        <option value="Partially">Partially Furnished</option>
        <option value="No">Unfurnished</option>
    </select>

<select id="filterRace">
    <option value="">Race ä¸é™</option>
    <option value="All Race">All Race</option>        <!-- A -->
    <option value="Malay">Only Malay</option>         <!-- B -->
    <option value="Indian">Only Indian</option>       <!-- C -->
    <option value="Chinese">Only Chinese</option>     <!-- D -->
</select>


    <button class="btn btn-small btn-secondary" id="applyFilters">æœç´¢</button>
    <button class="btn btn-small btn-secondary" id="resetFilters">é‡ç½®</button>
</div>


                    <div id="listingsContainer" class="listing-grid"></div>
                </div>
            </div>

            <div id="my-listings" class="section">
                <div class="card">
                    <h2>æˆ‘çš„æˆ¿æº</h2>
                    <div id="myListingsContainer" class="listing-grid"></div>
                </div>
            </div>

            <div id="export" class="section">
                <div class="card">
                    <h2>å¯¼å‡ºæ•°æ®</h2>
                    <p>é€‰æ‹©è¦å¯¼å‡ºçš„æ ¼å¼ï¼š</p>
                    <div style="margin-top: 20px; display: flex; gap: 10px;">
                        <button class="btn btn-primary" id="exportJSON">ğŸ“¥ å¯¼å‡ºä¸º JSON</button>
                        <button class="btn btn-primary" id="exportCSV">ğŸ“¥ å¯¼å‡ºä¸º CSV</button>
                    </div>
                </div>
            </div>

            <div id="settings" class="section">
                <div class="card">
                    <h2>è´¦æˆ·è®¾ç½®</h2>
                    <div class="form-group">
                        <label>å½“å‰ç”¨æˆ·å</label>
                        <input type="text" id="settingsUsername" disabled>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="listingModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" id="closeModal">Ã—</button>
            <div id="modalContent"></div>
        </div>
    </div>

    <script type="module">
        import { getAuth, RecaptchaVerifier, signInWithPhoneNumber, onAuthStateChanged } 
            from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";

        // å¤ç”¨å‰é¢åˆå§‹åŒ–å¥½çš„ appï¼ˆä½ å·²ç»åœ¨ä¸Šé¢çš„ script type="module" é‡Œ initializeApp äº†ï¼‰
        const auth = getAuth();

        // åœ¨æ‰‹æœºç™»å½•è¡¨å•åŠ è½½ååˆå§‹åŒ– reCAPTCHA
        window.onload = function() {
            // åˆ›å»ºä¸å¯è§æˆ–å¯è§çš„ reCAPTCHA
            window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', {
                size: 'normal',
                callback: (response) => {
                    // éªŒè¯é€šè¿‡ï¼Œå¯ä»¥å‘é€éªŒè¯ç 
                    console.log('reCAPTCHA verified');
                }
            });
        };

        // å‘é€éªŒè¯ç æŒ‰é’®
        const sendCodeBtn = document.getElementById('sendCodeBtn');
        if (sendCodeBtn) {
            sendCodeBtn.addEventListener('click', async () => {
                const phoneNumberInput = document.getElementById('phoneNumber');
                const phoneNumber = phoneNumberInput.value.trim();
                if (!phoneNumber) {
                    alert('è¯·è¾“å…¥æ‰‹æœºå·ç ï¼ˆåŒ…æ‹¬å›½å®¶åŒºå·ï¼Œä¾‹å¦‚ +60ï¼‰');
                    return;
                }

                try {
                    const appVerifier = window.recaptchaVerifier;
                    window.confirmationResult = await signInWithPhoneNumber(auth, phoneNumber, appVerifier);
                    alert('éªŒè¯ç å·²å‘é€ï¼Œè¯·æ£€æŸ¥æ‰‹æœºçŸ­ä¿¡');
                } catch (error) {
                    console.error(error);
                    alert('å‘é€éªŒè¯ç å¤±è´¥ï¼š' + (error.message || 'è¯·ç¨åå†è¯•'));
                }
            });
        }

        // ç¡®è®¤éªŒè¯ç æŒ‰é’®
        const confirmCodeBtn = document.getElementById('confirmCodeBtn');
        if (confirmCodeBtn) {
            confirmCodeBtn.addEventListener('click', async () => {
                const codeInput = document.getElementById('smsCode');
                const code = codeInput.value.trim();
                if (!code) {
                    alert('è¯·è¾“å…¥çŸ­ä¿¡éªŒè¯ç ');
                    return;
                }

                try {
                    const result = await window.confirmationResult.confirm(code);
                    const user = result.user;
                    // user.uid å°±æ˜¯è¿™ä¸ªæ¸¸å®¢çš„å”¯ä¸€ ID
                    alert('æ‰‹æœºç™»å½•æˆåŠŸï¼Œæ¬¢è¿ï¼');

                    // TODOï¼šè¿™é‡Œä½ å¯ä»¥æŠŠ user.uid å†™åˆ°ä½ ç°æœ‰çš„ currentUser å˜é‡é‡Œï¼Œ
                    // å¹¶ä¸”è·³è½¬åˆ°ä¸»ç•Œé¢ï¼ˆå’ŒåŸæ¥ç”¨æˆ·åå¯†ç ç™»å½•ç±»ä¼¼ï¼‰
                    // ä¾‹å¦‚ï¼š
                    window._phoneLoggedInUser = user;
                    // åé¢åœ¨ä½ çš„æ—§è„šæœ¬é‡Œå¯ä»¥è¯»å– window._phoneLoggedInUser
                } catch (error) {
                    console.error(error);
                    alert('éªŒè¯ç é”™è¯¯æˆ–å·²è¿‡æœŸï¼Œè¯·é‡è¯•');
                }
            });
        }

        // å¯é€‰ï¼šç›‘å¬ç™»å½•çŠ¶æ€å˜åŒ–
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log('Firebase Auth å·²ç™»å½• uid:', user.uid);
            } else {
                console.log('Firebase Auth å·²ç™»å‡º');
            }
        });
    </script>

    
    <script>
let users = {
    admin: { password: '111111', role: 'admin' },
    looannshen: { password: '123456', role: 'agent' },
    laiweehong: { password: '123456', role: 'agent' },
    hausiewhua: { password: '123456', role: 'agent' },
    ganjooinn: { password: '123456', role: 'agent' },
    tanchunkiat: { password: '123456', role: 'agent' },
    wongmingli: { password: '123456', role: 'agent' },
    gohjunkhai: { password: '123456', role: 'agent' }
};

let listings = [];
let editingListingId = null;   // å½“å‰æ­£åœ¨ç¼–è¾‘çš„æˆ¿æº idï¼ˆnull è¡¨ç¤ºæ–°å¢ï¼‰
        // ç”Ÿæˆå”¯ä¸€çš„æˆ¿æºç¼–å·ï¼Œä¾‹å¦‚ LR1001ã€LR1002 ...
async function getNextListingCode() {
    const { db, collection, doc, runTransaction } = window._firestore;
    const countersCol = collection(db, "meta");
    const counterRef = doc(countersCol, "listingCode");

    const code = await runTransaction(db, async (tx) => {
        const snap = await tx.get(counterRef);
        let data = snap.data();

        if (!snap.exists() || !data || typeof data.current !== 'number') {
            // ç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼Œä» 1000 å¼€å§‹
            data = { prefix: "LR", current: 1000 };
        }

        const next = data.current + 1;
        tx.set(counterRef, { prefix: data.prefix || "LR", current: next }, { merge: true });

        // LR + å››ä½æ•°ï¼Œä¾‹å¦‚ LR1001
        return (data.prefix || "LR") + String(next).padStart(4, '0');
    });

    return code;
}

let currentUser = null;
let uploadedImages = [];
let uploadedFiles = [];

// ä» Firestore æ‹‰å–æˆ¿æº
async function loadListingsFromFirestore() {
    const { db, collection, getDocs, query, orderBy } = window._firestore;
    const q = query(collection(db, "listings"), orderBy("date", "desc"));
    const snap = await getDocs(q);
    listings = [];
    snap.forEach(docSnap => {
        listings.push({
            id: docSnap.id,
            ...docSnap.data()
        });
    });
}

// è¯»å–æœ€è¿‘ 7 å¤©åˆ é™¤çš„æˆ¿æº
async function loadDeletedListingsLast7Days() {
    const { db, collection, getDocs } = window._firestore;
    const deletedCol = collection(db, "deleted_listings");
    const snap = await getDocs(deletedCol);

    const now = new Date();
    const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);

    const deleted = [];
    snap.forEach(docSnap => {
        const data = docSnap.data();
        if (!data.deletedAt) return;
        const delDate = new Date(data.deletedAt);
        if (delDate >= sevenDaysAgo) {
            deleted.push({
                id: docSnap.id,
                ...data
            });
        }
    });

    // æŒ‰åˆ é™¤æ—¶é—´å€’åº
    deleted.sort((a, b) => new Date(b.deletedAt) - new Date(a.deletedAt));
    return deleted;
}

// ç™»å½•
document.getElementById('loginForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;

    if (users[username] && users[username].password === password) {
        currentUser = username;
        document.getElementById('loginPage').style.display = 'none';
        document.getElementById('mainApp').classList.add('active');
        document.getElementById('currentUser').textContent = username;
        document.getElementById('settingsUsername').value = username;
        
        await loadListingsFromFirestore();
        updateDashboard();
        refreshListings();
        refreshMyListings();
        startClock();
    } else {
        alert('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ï¼');
    }
});

// ç™»å‡º
document.getElementById('logoutBtn').addEventListener('click', function() {
    if (confirm('ç¡®å®šè¦ç™»å‡ºå—ï¼Ÿ')) {
        currentUser = null;
        document.getElementById('mainApp').classList.remove('active');
        document.getElementById('loginPage').style.display = 'flex';
        document.getElementById('loginForm').reset();
    }
});

// èœå•å¯¼èˆª
document.querySelectorAll('.menu-link').forEach(link => {
    link.addEventListener('click', function(e) {
        e.preventDefault();
        const section = this.dataset.section;
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(section).classList.add('active');
        document.querySelectorAll('.menu-link').forEach(l => l.classList.remove('active'));
        this.classList.add('active');

        if (section === 'listings') refreshListings();
        if (section === 'my-listings') refreshMyListings();
    });
});

// æ—¶é’Ÿ
function startClock() {
    function updateTime() {
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');
        document.getElementById('currentTime').textContent = `${hours}:${minutes}:${seconds}`;
    }
    updateTime();
    setInterval(updateTime, 1000);
}

// å›¾ç‰‡ä¸Šä¼ å¤„ç†
document.getElementById('imageUpload').addEventListener('click', function() {
    document.getElementById('imageInput').click();
});

document.getElementById('imageUpload').addEventListener('dragover', function(e) {
    e.preventDefault();
    this.style.backgroundColor = 'rgba(52, 152, 219, 0.1)';
});

document.getElementById('imageUpload').addEventListener('dragleave', function() {
    this.style.backgroundColor = '';
});

document.getElementById('imageUpload').addEventListener('drop', function(e) {
    e.preventDefault();
    this.style.backgroundColor = '';
    handleImages(e.dataTransfer.files);
});

document.getElementById('imageInput').addEventListener('change', function() {
    handleImages(this.files);
});

function handleImages(files) {
    if (uploadedImages.length + files.length > 20) {
        alert('æœ€å¤šåªèƒ½ä¸Šä¼ 20å¼ å›¾ç‰‡');
        return;
    }

    for (let file of files) {
        if (file.type.startsWith('image/')) {
            uploadedFiles.push(file);
            const reader = new FileReader();
            reader.onload = function(e) {
                uploadedImages.push(e.target.result);
                displayImagePreviews();
            };
            reader.readAsDataURL(file);
        }
    }
}

function displayImagePreviews() {
    const preview = document.getElementById('imagePreview');
    preview.innerHTML = '';
    uploadedImages.forEach((img, index) => {
        const item = document.createElement('div');
        item.className = 'image-item';
        item.innerHTML = `
            <img src="${img}" alt="preview">
            <button class="remove-btn" type="button" data-index="${index}">Ã—</button>
        `;
        preview.appendChild(item);
    });

    document.querySelectorAll('.remove-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const index = parseInt(this.dataset.index);
            uploadedImages.splice(index, 1);
            uploadedFiles.splice(index, 1);
            displayImagePreviews();
        });
    });
}

// æ–‡æ¡ˆç”Ÿæˆ
document.getElementById('generateCaption').addEventListener('click', function(e) {
    e.preventDefault();
    const type = document.getElementById('propertyType').value;
    const location = document.getElementById('location').value;
    const price = document.getElementById('price').value;
    const area = document.getElementById('area').value;
    const bedrooms = document.getElementById('bedrooms').value;
    const bathrooms = document.getElementById('bathrooms').value;
        // æ”¶é›†å‹¾é€‰çš„ Race
    const raceChecked = Array
        .from(document.querySelectorAll('input[name="race"]:checked'))
        .map(c => c.value);   // ä¾‹å¦‚ ["Malay","Chinese"]


    if (!type || !location || !price || !area) {
        alert('è¯·å…ˆå¡«å†™æˆ¿äº§ç±»å‹ã€ä½ç½®ã€ä»·æ ¼å’Œé¢ç§¯');
        return;
    }

    const caption = generateCaption(type, location, price, area, bedrooms, bathrooms);
    document.getElementById('generatedCaption').innerHTML = `<div class="generated-caption">${caption}</div>`;
});

function generateCaption(type, location, price, area, bedrooms, bathrooms) {
    const furnished = document.getElementById('furnished').value || '';
    const floor = document.getElementById('floor').value || '';
    const carpark = document.getElementById('carpark').value || '';
    const direction = document.getElementById('direction').value || '';
    const agentName = document.getElementById('agentName').value || '';
    const nearby1 = document.getElementById('nearby1').value || '';
    const nearby2 = document.getElementById('nearby2').value || '';
    const nearby3 = document.getElementById('nearby3').value || '';
    const nearby4 = document.getElementById('nearby4').value || '';

    const priceText = parseInt(price).toLocaleString();
    
    // æ ‡é¢˜ï¼šå»æ‰ä¸­æ‹¬å·
    const furnishedTitle = furnished ? `${furnished} Furnished ` : '';
    const title = `${furnishedTitle}${location} â€“ ${type} For Rent RM${priceText}`;

    // ç”¨ä¸åŒå›¾æ ‡
    let detailsLines = [];
    if (bedrooms) detailsLines.push(`ğŸ› ${bedrooms} Bedrooms`);
    if (bathrooms) detailsLines.push(`ğŸ› ${bathrooms} Bathrooms`);
    if (area) detailsLines.push(`ğŸ“ Size ${area} sq.ft`);
    if (furnished) detailsLines.push(`ğŸ›‹ ${furnished} Furnished `);
    if (floor) detailsLines.push(`ğŸ¢ Floor: ${floor}`);
    if (carpark) detailsLines.push(`ğŸš— Car Park: ${carpark}`);
    if (direction) detailsLines.push(`ğŸ§­ Direction: ${direction}`);

    const detailsBlock = detailsLines.length ? `House Details:\n${detailsLines.join('\n')}` : '';

    let nearbyLines = [];
    if (nearby1) nearbyLines.push(`ğŸ“ ${nearby1}`);
    if (nearby2) nearbyLines.push(`ğŸ“ ${nearby2}`);
    if (nearby3) nearbyLines.push(`ğŸ“ ${nearby3}`);
    if (nearby4) nearbyLines.push(`ğŸ“ ${nearby4}`);

    const nearbyBlock = nearbyLines.length ? `Nearby Access:\n${nearbyLines.join('\n')}` : '';
    const contactLine = agentName ? `â˜ï¸ Interested, please contact ${agentName}.` : `â˜ï¸ Interested, please contact for more details.`;

    return [title, '', detailsBlock, '', nearbyBlock, '', contactLine].filter(Boolean).join('\n');
}

// å¤åˆ¶æ–‡æ¡ˆ
document.getElementById('copyCaption').addEventListener('click', async function() {
    const text = document.getElementById('generatedCaption').innerText.trim();
    if (!text) {
        alert('æ²¡æœ‰å¯ä»¥å¤åˆ¶çš„æ–‡æ¡ˆ');
        return;
    }

    try {
        await navigator.clipboard.writeText(text);
        alert('æ–‡æ¡ˆå·²å¤åˆ¶');
    } catch (err) {
        alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰ä¸­æ–‡æ¡ˆå¤åˆ¶');
    }
});

// ä¸Šä¼ è¡¨å•æäº¤
async function uploadImagesToStorage(files, listingId) {
    const { storage, ref, uploadBytes, getDownloadURL } = window._storage;
    const urls = [];

    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const path = `listings/${listingId}/${Date.now()}_${file.name}`;
        const storageRef = ref(storage, path);
        await uploadBytes(storageRef, file);
        const url = await getDownloadURL(storageRef);
        urls.push(url);
    }
    return urls;
}

document.getElementById('uploadForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    if (uploadedFiles.length === 0 && !editingListingId) {
        // æ–°å¢å¿…é¡»è‡³å°‘ 1 å¼ å›¾ï¼›ç¼–è¾‘æ¨¡å¼å¯ä»¥ä¸é‡æ–°ä¸Šä¼ å›¾ç‰‡
        alert('è¯·è‡³å°‘ä¸Šä¼ ä¸€å¼ å›¾ç‰‡');
        return;
    }

    const raceValues = Array.from(
        document.querySelectorAll('input[name="race"]:checked')
    ).map(c => c.value);

    const baseData = {
        user: currentUser,
        type: document.getElementById('propertyType').value,
        location: document.getElementById('location').value,
        state: document.getElementById('state').value,
        price: parseInt(document.getElementById('price').value),
        area: document.getElementById('area').value,
        bedrooms: parseInt(document.getElementById('bedrooms').value),
        bathrooms: parseInt(document.getElementById('bathrooms').value),
        floor: document.getElementById('floor').value,
        carpark: document.getElementById('carpark').value,
        direction: document.getElementById('direction').value,
        furnished: document.getElementById('furnished').value,
        race: raceValues,  // âœ… æ–°å¢ï¼šRace æ•°ç»„
        securityDeposit: document.getElementById('securityDeposit').value,
        utilitiesDeposit: document.getElementById('utilitiesDeposit').value,
        otherDeposit: document.getElementById('otherDeposit').value,
        remarks: document.getElementById('remarks').value,
        agentName: document.getElementById('agentName').value,
        address: document.getElementById('address').value,
        nearby1: document.getElementById('nearby1').value,
        nearby2: document.getElementById('nearby2').value,
        nearby3: document.getElementById('nearby3').value,
        nearby4: document.getElementById('nearby4').value,
        caption: document.getElementById('generatedCaption').textContent,
        // date åœ¨æ–°å¢åˆ†æ”¯é‡Œç”¨ new Date().toISOString()
    };

    try {
        const { db, collection, doc, setDoc } = window._firestore;
        const listingsCol = collection(db, "listings");

        if (!editingListingId) {
            // ========== æ–°å¢ ==========
            const newDocRef = doc(listingsCol);

            // ç”Ÿæˆå”¯ä¸€ LR ç¼–å·
            const code = await getNextListingCode();
            const dataWithDate = { ...baseData, code, date: new Date().toISOString() };

            await setDoc(newDocRef, { ...dataWithDate, images: [] });
            const imageUrls = await uploadImagesToStorage(uploadedFiles, newDocRef.id);
            await setDoc(newDocRef, { ...dataWithDate, images: imageUrls }, { merge: true });

            alert('æˆ¿æºå‘å¸ƒæˆåŠŸï¼');
        } else {
            // ========== ç¼–è¾‘ ==========
            const listing = listings.find(l => l.id === editingListingId);
            if (!listing) {
                alert('æœªæ‰¾åˆ°è¦ç¼–è¾‘çš„æˆ¿æº');
                return;
            }

            const docRef = doc(listingsCol, editingListingId);

            // ä¿ç•™åŸæ¥çš„ code å’Œ date
            const dataToSave = {
                ...listing,         // å…ˆé“ºåŸå§‹æ•°æ®ï¼ˆå« code / date / imagesï¼‰
                ...baseData         // å†ç”¨è¡¨å•å†…å®¹è¦†ç›–å¯ç¼–è¾‘å­—æ®µ
            };

            // å¦‚æœè¿™æ¬¡æœ‰é‡æ–°ä¸Šä¼ å›¾ç‰‡ï¼Œå°±è¦†ç›– imagesï¼›å¦åˆ™ç”¨åŸ images
            if (uploadedFiles.length > 0) {
                const imageUrls = await uploadImagesToStorage(uploadedFiles, editingListingId);
                dataToSave.images = imageUrls;
            }

            await setDoc(docRef, dataToSave, { merge: false });

            alert('æˆ¿æºæ›´æ–°æˆåŠŸï¼');
        }

        // æäº¤åç»Ÿä¸€é‡ç½®
        editingListingId = null;
        document.getElementById('uploadForm').reset();
        uploadedImages = [];
        uploadedFiles = [];
        document.getElementById('imagePreview').innerHTML = '';
        document.getElementById('generatedCaption').innerHTML = '';

        await loadListingsFromFirestore();
        updateDashboard();
        refreshListings();
        refreshMyListings();
    } catch (err) {
        console.error(err);
        alert('æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
    }
});


// ä»ªè¡¨æ¿ - æ›´æ–°ç»Ÿè®¡æ•°æ® + æœ€è¿‘åˆ é™¤åˆ—è¡¨
async function updateDashboard() {
    document.getElementById('totalListings').textContent = listings.length;
    document.getElementById('myListings').textContent = listings.filter(l => l.user === currentUser).length;
    const uniqueUsers = new Set(listings.map(l => l.user)).size;
    document.getElementById('teamMembers').textContent = uniqueUsers;
    const thisMonth = listings.filter(l => new Date(l.date).getMonth() === new Date().getMonth()).length;
    document.getElementById('thisMonth').textContent = thisMonth;

    const recentContainer = document.getElementById('recentListings');
    recentContainer.innerHTML = '';
    listings.slice(0, 6).forEach(listing => {
        const card = createListingCard(listing);
        recentContainer.appendChild(card);
    });

    // === æœ€è¿‘ 7 å¤©åˆ é™¤çš„æˆ¿æºåˆ—è¡¨ ===
    const recentDeletedDiv = document.getElementById('recentDeleted');
    if (recentDeletedDiv) {
        recentDeletedDiv.innerHTML = 'åŠ è½½ä¸­...';
        try {
            const deleted = await loadDeletedListingsLast7Days();
            if (!deleted.length) {
                recentDeletedDiv.textContent = 'æœ€è¿‘ 7 å¤©æ²¡æœ‰åˆ é™¤è®°å½•ã€‚';
            } else {
recentDeletedDiv.innerHTML = deleted.map(item => {
    const delDate = item.deletedAt
        ? new Date(item.deletedAt).toLocaleString('zh-CN')
        : '-';
    const priceText = item.price ? 'RM ' + Number(item.price).toLocaleString() : '-';
    const isOwner = item.user === currentUser;

    return `
        <div style="padding: 8px 0; border-bottom: 1px solid #eee;">
            <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:10px;">
                <div>
                    <div><strong>${item.type || ''} - ${item.location || ''}</strong></div>
                    <div style="font-size: 12px; color: #7f8c8d;">ä»·æ ¼ï¼š${priceText} | åœ°å€ï¼š${item.address || '-'}</div>
                    <div style="font-size: 12px; color: #7f8c8d;">å‘å¸ƒè€…ï¼š${item.user || '-'} | åˆ é™¤äººï¼š${item.deletedBy || '-'}</div>
                    <div style="font-size: 11px; color: #95a5a6;">åˆ é™¤æ—¶é—´ï¼š${delDate}</div>
                </div>
                ${isOwner ? `
                <div style="display:flex; flex-direction:column; gap:4px;">
                    <button class="btn btn-small btn-secondary" onclick="restoreListing('${item.id}')">ğŸ”„ æ¢å¤</button>
                    <button class="btn btn-small btn-danger" onclick="permanentlyDeleteListing('${item.id}')">ğŸ—‘ å½»åº•åˆ é™¤</button>
                </div>
                ` : ''}
            </div>
        </div>
    `;
}).join('');

            }
        } catch (e) {
            console.error('è¯»å–åˆ é™¤è®°å½•å¤±è´¥:', e);
            recentDeletedDiv.textContent = 'è¯»å–åˆ é™¤è®°å½•å¤±è´¥ã€‚';
        }
    }
}

function createListingCard(listing) {
    const card = document.createElement('div');
    card.className = 'listing-card';
    card.dataset.listingId = listing.id;
    card.innerHTML = `
        <div class="listing-card-image">
            ${listing.images && listing.images[0] ? `<img src="${listing.images[0]}" alt="${listing.type}">` : '<span>æš‚æ— å›¾ç‰‡</span>'}
        </div>
        <div class="listing-card-content">
            <div class="listing-card-title">
    ${listing.type} - ${listing.location}
    ${listing.code ? `<span style="font-size:12px;color:#7f8c8d;"> [${listing.code}]</span>` : ''}
</div>
<div class="listing-card-price">RM ${listing.price.toLocaleString()}</div>
<div class="listing-card-info">
    <p>${listing.bedrooms}æˆ¿ ${listing.bathrooms}å• | ${listing.area} sq.ft</p>
    <p>å·å±ï¼š${listing.state || '-'}</p>
    <p>Raceï¼š${(listing.race && listing.race.length) ? listing.race.join(', ') : 'All Race'}</p>
    <p>åœ°å€ï¼š${listing.address || '-'}</p>
    <p>å‘å¸ƒè€…ï¼š${listing.user}</p>
</div>


            <div class="listing-card-actions">
    <button class="btn btn-small btn-primary view-btn">æŸ¥çœ‹è¯¦æƒ…</button>
    ${listing.user === currentUser ? `
        <button class="btn btn-small btn-secondary edit-btn">ç¼–è¾‘</button>
        <button class="btn btn-small btn-danger delete-btn">åˆ é™¤</button>
    ` : ''}
</div>

        </div>
    `;

    card.querySelector('.view-btn').addEventListener('click', () => viewListing(listing.id));
if (listing.user === currentUser) {
    card.querySelector('.edit-btn').addEventListener('click', () => startEditListing(listing.id));
    card.querySelector('.delete-btn').addEventListener('click', () => deleteListing(listing.id));
}


    return card;
}
        
function startEditListing(id) {
    const listing = listings.find(l => l.id === id);
    if (!listing) {
        alert('æœªæ‰¾åˆ°è¦ç¼–è¾‘çš„æˆ¿æº');
        return;
    }

    editingListingId = id;

    // åˆ‡åˆ°â€œä¸Šä¼ æˆ¿æºâ€tab
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById('upload').classList.add('active');
    document.querySelectorAll('.menu-link').forEach(l => l.classList.remove('active'));
    document.querySelector('.menu-link[data-section="upload"]').classList.add('active');

    // å¡«å……è¡¨å•å­—æ®µ
    document.getElementById('propertyType').value = listing.type || '';
    document.getElementById('location').value = listing.location || '';
    if (document.getElementById('state')) {
        document.getElementById('state').value = listing.state || '';
    }
    document.getElementById('price').value = listing.price || '';
    document.getElementById('area').value = listing.area || '';
    document.getElementById('bedrooms').value = listing.bedrooms || 0;
    document.getElementById('bathrooms').value = listing.bathrooms || 0;
    document.getElementById('floor').value = listing.floor || '';
    document.getElementById('carpark').value = listing.carpark || '';
    document.getElementById('direction').value = listing.direction || '';
    document.getElementById('furnished').value = listing.furnished || '';
    document.getElementById('securityDeposit').value = listing.securityDeposit || '';
    document.getElementById('utilitiesDeposit').value = listing.utilitiesDeposit || '';
    document.getElementById('otherDeposit').value = listing.otherDeposit || '';
    document.getElementById('remarks').value = listing.remarks || '';
    document.getElementById('agentName').value = listing.agentName || '';
    document.getElementById('address').value = listing.address || '';
    document.getElementById('nearby1').value = listing.nearby1 || '';
    document.getElementById('nearby2').value = listing.nearby2 || '';
    document.getElementById('nearby3').value = listing.nearby3 || '';
    document.getElementById('nearby4').value = listing.nearby4 || '';
        // æ¢å¤ Race å¤šé€‰
    document.querySelectorAll('input[name="race"]').forEach(cb => {
        cb.checked = Array.isArray(listing.race) && listing.race.includes(cb.value);
    });


    // æ–‡æ¡ˆæ˜¾ç¤ºï¼ˆä¸å¼ºåˆ¶é‡æ–°ç”Ÿæˆï¼‰
    document.getElementById('generatedCaption').innerHTML = listing.caption
        ? `<div class="generated-caption">${listing.caption.replace(/\n/g, '<br>')}</div>`
        : '';

    // é¢„è§ˆåŒºæ¸…ç©ºï¼Œè®©ä½ å†³å®šè¦ä¸è¦é‡æ–°ä¼ å›¾ï¼ˆç°åœ¨ç¼–è¾‘ä¸è‡ªåŠ¨è½½å…¥æ—§å›¾ï¼Œåªå½±å“æ–°çš„ä¸Šä¼ ï¼‰
    uploadedImages = [];
    uploadedFiles = [];
    document.getElementById('imagePreview').innerHTML = '';

    alert(`æ­£åœ¨ç¼–è¾‘æˆ¿æºï¼š${listing.code || ''} ${listing.location || ''}`);
}

function viewListing(id) {
    const listing = listings.find(l => l.id === id);
    if (!listing) return;

    const modal = document.getElementById('listingModal');
    const modalContent = document.getElementById('modalContent');

    let galleryHTML = '';
    if (listing.images && listing.images.length > 0) {
        galleryHTML = `
            <img src="${listing.images[0]}" class="listing-detail-image" id="mainImage" alt="${listing.type}">
        `;
    }

    modalContent.innerHTML = `
        <h2 style="margin-bottom: 20px;">${listing.type} - ${listing.location}</h2>
        ${galleryHTML}
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            <div>
                <p><strong style="color: #27ae60; font-size: 18px;">RM ${listing.price.toLocaleString()}</strong></p>
                <p><strong>é¢ç§¯ï¼š</strong> ${listing.area || '-'} sq.ft</p>
                <p><strong>æˆ¿é—´/æµ´å®¤ï¼š</strong> ${listing.bedrooms || 0} æˆ¿ ${listing.bathrooms || 0} å•</p>
            </div>
            <div>
                <p><strong>å‘å¸ƒè€…ï¼š</strong> ${listing.user || '-'}</p>
                <p><strong>å‘å¸ƒæ—¶é—´ï¼š</strong> ${listing.date ? new Date(listing.date).toLocaleDateString('zh-CN') : '-'}</p>
            </div>
        </div>

        <div style="margin-bottom: 20px;">
            <h3>è¯¦ç»†èµ„æ–™</h3>
            <p><strong>å·å±ï¼š</strong> ${listing.state || '-'}</p>
            <p><strong>Raceï¼š</strong> ${(listing.race && listing.race.length) ? listing.race.join(', ') : 'All Race'}</p>
            <p><strong>æ¥¼å±‚ï¼š</strong> ${listing.floor || '-'}</p>
            <p><strong>åœè½¦ä½ï¼š</strong> ${listing.carpark || '-'}</p>
            <p><strong>æœå‘ï¼š</strong> ${listing.direction || '-'}</p>
            <p><strong>å®¶ç§ï¼š</strong> ${listing.furnished || '-'}</p>
            <p><strong>Security Depositï¼š</strong> ${listing.securityDeposit || '-'}</p>
            <p><strong>Utilities Depositï¼š</strong> ${listing.utilitiesDeposit || '-'}</p>
            <p><strong>Other Depositï¼š</strong> ${listing.otherDeposit || '-'}</p>
        </div>

        <div style="margin-bottom: 20px;">
            <h3>å‘¨è¾¹é…å¥—</h3>
            <p><strong>Nearby 1ï¼š</strong> ${listing.nearby1 || '-'}</p>
            <p><strong>Nearby 2ï¼š</strong> ${listing.nearby2 || '-'}</p>
            <p><strong>Nearby 3ï¼š</strong> ${listing.nearby3 || '-'}</p>
            <p><strong>Nearby 4ï¼š</strong> ${listing.nearby4 || '-'}</p>
        </div>

        <div style="margin-bottom: 20px;">
            <h3>Agent / åœ°å€ / å¤‡æ³¨</h3>
            <p><strong>Agentï¼š</strong> ${listing.agentName || '-'}</p>
            <p><strong>åœ°å€ï¼š</strong> ${listing.address || '-'}</p>
            <p><strong>å¤‡æ³¨ï¼š</strong> ${listing.remarks || '-'}</p>
        </div>

        <div style="margin-bottom: 20px;">
            <h3>æˆ¿æºæ–‡æ¡ˆ</h3>
            <div class="generated-caption">
                ${listing.caption ? listing.caption.replace(/\n/g, '<br>') : 'æš‚æ— æ–‡æ¡ˆ'}
            </div>
        </div>

<div style="display: flex; gap: 10px; flex-wrap: wrap;">
    <button class="btn btn-primary btn-small copy-caption-btn">ğŸ“‹ å¤åˆ¶æ–‡æ¡ˆ</button>
    <button class="btn btn-secondary btn-small download-images-btn">ğŸ“¥ ä¸‹è½½æ‰€æœ‰å›¾ç‰‡</button>
    ${listing.user === currentUser ? `
        <button class="btn btn-small btn-secondary edit-listing-btn">âœï¸ ç¼–è¾‘</button>
    ` : ''}
    <button class="btn btn-secondary btn-small close-modal-btn">å…³é—­</button>
</div>

    `;

modalContent.querySelector('.copy-caption-btn')
    .addEventListener('click', () => copyListingCaption(listing.id));
modalContent.querySelector('.download-images-btn')
    .addEventListener('click', () => downloadImages(listing.id));
const editBtn = modalContent.querySelector('.edit-listing-btn');
if (editBtn) {
    editBtn.addEventListener('click', () => {
        startEditListing(listing.id);
        modal.classList.remove('active');
    });
}
modalContent.querySelector('.close-modal-btn')
    .addEventListener('click', () => modal.classList.remove('active'));


    modal.classList.add('active');
}

function copyListingCaption(id) {
    const listing = listings.find(l => l.id === id);
    if (!listing || !listing.caption) {
        alert('æ²¡æœ‰å¯å¤åˆ¶çš„æ–‡æ¡ˆ');
        return;
    }

    navigator.clipboard.writeText(listing.caption).then(() => {
        alert('æ–‡æ¡ˆå·²å¤åˆ¶ï¼');
    }).catch(err => {
        console.error(err);
        alert('å¤åˆ¶å¤±è´¥');
    });
}

// ä¸€é”®é™é»˜ä¸‹è½½ï¼ˆéœ€è¦ Firebase Storage å·²æ­£ç¡®é…ç½® CORSï¼‰
function downloadImages(id) {
    const listing = listings.find(l => l.id === id);
    if (!listing || !listing.images || !listing.images.length) {
        alert('æ²¡æœ‰å¯ä¸‹è½½çš„å›¾ç‰‡');
        return;
    }

    const total = listing.images.length;
    let success = 0;
    let fail = 0;

    alert('å¼€å§‹ä¸ºä½ å‡†å¤‡ä¸‹è½½å›¾ç‰‡ï¼Œè¯·ç­‰å¾…å‡ ç§’ï¼Œä¸è¦å…³é—­é¡µé¢ã€‚');

    listing.images.forEach((img, idx) => {
        const imageUrl = img;

        fetch(imageUrl)
            .then(res => {
                if (!res.ok) {
                    throw new Error('HTTP ' + res.status);
                }
                return res.blob();
            })
            .then(blob => {
                const blobUrl = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = blobUrl;
                a.download = `${listing.location || 'image'}_${idx + 1}.jpg`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(blobUrl);
                success++;
            })
            .catch(err => {
                console.error('ä¸‹è½½å¤±è´¥', idx + 1, err);
                fail++;
            })
            .finally(() => {
                if (success + fail === total) {
                    alert(`ä¸‹è½½å®Œæˆï¼šæˆåŠŸ ${success} å¼ ï¼Œå¤±è´¥ ${fail} å¼ `);
                }
            });
    });
}


// è½¯åˆ é™¤ï¼šå…ˆå†™åˆ° deleted_listingsï¼Œå†ä» listings åˆ é™¤
async function deleteListing(id) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æˆ¿æºå—ï¼Ÿ')) return;

    try {
        const { db, deleteDoc, doc, collection, setDoc } = window._firestore;
        const listing = listings.find(l => l.id === id);
        if (!listing) {
            alert('è¿™æ¡æˆ¿æºä¸å­˜åœ¨');
            return;
        }

        // 1) å…ˆå†™å…¥ deleted_listings
        const deletedCol = collection(db, "deleted_listings");
        const deletedDocRef = doc(deletedCol, id);
        await setDoc(deletedDocRef, {
            ...listing,
            deletedAt: new Date().toISOString(),
            deletedBy: currentUser
        });

        // 2) å†ä» listings æ­£å¼åˆ é™¤
        await deleteDoc(doc(db, "listings", id));

        // 3) åˆ·æ–°æœ¬åœ°æ•°æ®
        await loadListingsFromFirestore();
        updateDashboard();
        refreshListings();
        refreshMyListings();
        alert('åˆ é™¤æˆåŠŸï¼è¯¥æˆ¿æºå·²è®°å½•åˆ°"åˆ é™¤è®°å½•"é‡Œã€‚');


    } catch (err) {
        console.error(err);
        alert('åˆ é™¤å¤±è´¥: ' + err.message);
    }
}
        // ä» deleted_listings æ¢å¤åˆ° listings
// ä» deleted_listings æ¢å¤åˆ° listingsï¼ˆåªæœ‰åŸå‘å¸ƒè€…å¯ä»¥æ¢å¤ï¼‰
async function restoreListing(id) {
    if (!confirm('ç¡®å®šè¦æ¢å¤è¿™æ¡æˆ¿æºå—ï¼Ÿ')) return;

    try {
        const { db, collection, doc, getDocs, setDoc, deleteDoc } = window._firestore;

        // 1ï¼‰ä» deleted_listings é‡Œæ‰¾åˆ°è¿™æ¡è®°å½•
        const deletedCol = collection(db, "deleted_listings");
        const snap = await getDocs(deletedCol);
        let dataToRestore = null;
        snap.forEach(d => {
            if (d.id === id) {
                dataToRestore = d.data();
            }
        });
        if (!dataToRestore) {
            alert('æœªæ‰¾åˆ°è¦æ¢å¤çš„è®°å½•');
            return;
        }

        // âœ… æƒé™æ£€æŸ¥ï¼šåªæœ‰åŸå‘å¸ƒè€…æœ¬äººå¯ä»¥æ¢å¤
        if (dataToRestore.user !== currentUser) {
            alert('ä½ ä¸æ˜¯è¿™æ¡æˆ¿æºçš„å‘å¸ƒè€…ï¼Œä¸èƒ½æ¢å¤ã€‚');
            return;
        }

        // åˆ é™¤æ—¶åŠ çš„å­—æ®µä¸éœ€è¦å†™å›
        const { deletedAt, deletedBy, ...listingData } = dataToRestore;

        // 2ï¼‰å†™å› listingsï¼ˆç”¨åŒä¸€ä¸ª idï¼‰
        const listingsCol = collection(db, "listings");
        const listingDocRef = doc(listingsCol, id);
        await setDoc(listingDocRef, listingData);

        // 3ï¼‰ä» deleted_listings åˆ é™¤è¿™æ¡è®°å½•
        await deleteDoc(doc(db, "deleted_listings", id));

        // 4ï¼‰åˆ·æ–°
        await loadListingsFromFirestore();
        await updateDashboard();
        refreshListings();
        refreshMyListings();

        alert('æ¢å¤æˆåŠŸï¼è¯¥æˆ¿æºå·²å›åˆ°æˆ¿æºåº“ã€‚');
    } catch (err) {
        console.error(err);
        alert('æ¢å¤å¤±è´¥ï¼š' + err.message);
    }
}
        // ä» deleted_listings ä¸­å½»åº•åˆ é™¤ï¼ˆä¸å¯æ¢å¤ï¼‰
async function permanentlyDeleteListing(id) {
    if (!confirm('ç¡®å®šè¦ã€å½»åº•åˆ é™¤ã€‘è¿™æ¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;

    try {
        const { db, collection, getDocs, deleteDoc, doc } = window._firestore;

        // è¯»å‡ºè¿™æ¡ deleted_listings è®°å½•ï¼Œæ£€æŸ¥ user
        const deletedCol = collection(db, "deleted_listings");
        const snap = await getDocs(deletedCol);
        let record = null;
        snap.forEach(d => {
            if (d.id === id) {
                record = d.data();
            }
        });
        if (!record) {
            alert('æœªæ‰¾åˆ°è¦åˆ é™¤çš„è®°å½•');
            return;
        }

        if (record.user !== currentUser) {
            alert('ä½ ä¸æ˜¯è¿™æ¡æˆ¿æºçš„å‘å¸ƒè€…ï¼Œä¸èƒ½å½»åº•åˆ é™¤ã€‚');
            return;
        }

        await deleteDoc(doc(db, "deleted_listings", id));
        await updateDashboard();
        alert('å·²ä»åˆ é™¤è®°å½•ä¸­å½»åº•åˆ é™¤ã€‚');
    } catch (err) {
        console.error(err);
        alert('å½»åº•åˆ é™¤å¤±è´¥ï¼š' + err.message);
    }
}



function filterListingCommon(l) {
    const keywordInput = document.getElementById('searchListings');
    const stateSelect = document.getElementById('filterState');
    const priceMinInput = document.getElementById('priceMin');
    const priceMaxInput = document.getElementById('priceMax');
    const furnishedSelect = document.getElementById('filterFurnished');
    const raceSelect = document.getElementById('filterRace');

    const keyword = keywordInput ? keywordInput.value.trim().toLowerCase() : '';
    const stateFilter = stateSelect ? stateSelect.value : '';
    const priceMin = priceMinInput && priceMinInput.value ? Number(priceMinInput.value) : null;
    const priceMax = priceMaxInput && priceMaxInput.value ? Number(priceMaxInput.value) : null;
    const furnishedFilter = furnishedSelect ? furnishedSelect.value : '';
    const raceFilter = raceSelect ? raceSelect.value : '';

    const text = [
        l.location || '',
        l.type || '',
        String(l.price || ''),
        l.code || ''
    ].join(' ').toLowerCase();
    const matchKeyword = !keyword || text.includes(keyword);

    const matchState = !stateFilter || l.state === stateFilter;

    const price = Number(l.price || 0);
    const matchPriceMin = priceMin === null || price >= priceMin;
    const matchPriceMax = priceMax === null || price <= priceMax;

    const furnishedText = (l.furnished || '').toLowerCase();
    const matchFurnished = !furnishedFilter || furnishedText.includes(furnishedFilter.toLowerCase());

    // ===== Race é€»è¾‘ =====
    // ===== Race é€»è¾‘ï¼ˆåŒ…å« All Raceï¼‰=====
    const raceList = Array.isArray(l.race) ? l.race : [];

    let matchRace = true;

    if (!raceFilter) {
        matchRace = true;
    } else if (raceFilter === 'All Race') {
        matchRace = true;
    } else if (raceFilter === 'Malay') {
        matchRace =
            raceList.includes('Malay') ||
            raceList.includes('All Race') ||
            raceList.length === 0;
    } else if (raceFilter === 'Chinese') {
        matchRace =
            raceList.includes('Chinese') ||
            raceList.includes('All Race') ||
            raceList.length === 0;
    } else if (raceFilter === 'Indian') {
        matchRace =
            raceList.includes('Indian') ||
            raceList.includes('All Race') ||
            raceList.length === 0;
    }
    // ===== Race é€»è¾‘ç»“æŸ =====


    return matchKeyword && matchState && matchPriceMin && matchPriceMax && matchFurnished && matchRace;
}



function refreshListings() {
    const container = document.getElementById('listingsContainer');
    container.innerHTML = '';

    listings
        .filter(l => filterListingCommon(l))
        .forEach(listing => {
            container.appendChild(createListingCard(listing));
        });
}

function refreshMyListings() {
    const container = document.getElementById('myListingsContainer');
    container.innerHTML = '';

    listings
        .filter(l => l.user === currentUser)
        .filter(l => filterListingCommon(l))
        .forEach(listing => {
            container.appendChild(createListingCard(listing));
        });
}


// é«˜çº§ç­›é€‰æŒ‰é’®
const applyBtn = document.getElementById('applyFilters');
if (applyBtn) {
    applyBtn.addEventListener('click', () => {
        refreshListings();
        refreshMyListings();
    });
}

const resetBtn = document.getElementById('resetFilters');
if (resetBtn) {
    resetBtn.addEventListener('click', () => {
        if (document.getElementById('searchListings')) document.getElementById('searchListings').value = '';
        if (document.getElementById('filterState')) document.getElementById('filterState').value = '';
        if (document.getElementById('priceMin')) document.getElementById('priceMin').value = '';
        if (document.getElementById('priceMax')) document.getElementById('priceMax').value = '';
        if (document.getElementById('filterFurnished')) document.getElementById('filterFurnished').value = '';
        if (document.getElementById('filterRace')) document.getElementById('filterRace').value = '';
        refreshListings();
        refreshMyListings();
    });
}

// å…³é—­æ¨¡æ€æ¡†
document.getElementById('closeModal').addEventListener('click', function() {
    document.getElementById('listingModal').classList.remove('active');
});

document.getElementById('listingModal').addEventListener('click', function(e) {
    if (e.target === this) {
        this.classList.remove('active');
    }
});
    </script>
</body>

</html>
